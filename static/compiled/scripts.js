(()=>{"use strict";function t(t){if(t)return Array.isArray(t)?t.map(this.getErrorText.bind(this)).join("\n"):(t instanceof Error?t=t.message:"string"!=typeof t&&(t=String(t)),t)}function e(t,e){const a=e?"&#13;":"\n";return String(t).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,a).replace(/[\r\n]/g,a)}function a(t){const e=t/1e3,a=e/60,r=a/60,o=[r/24,r%24,a%60,e%60].map(Math.floor).map(((t,e)=>{if(!(e<2)||t)return e>=1?String(t).padStart(2,"0"):e?void 0:String(t)+"d"}));return[o.shift(),o.filter(Boolean).join(":")].filter(Boolean).join(" ")}var r=new(function(){function t(){}return t.prototype.updatePlayedCount=function(t,e,a){try{var r=a||Date.now(),o=this.getOrCreate(t);return isNaN(e)?o.playedCount=o.playedCount?o.playedCount+1:1:o.playedCount=e,o.lastPlayed=r,o.lastUpdated=r,this.insert(o),o}catch(e){console.error("[LocalTrackInfoDb:incrementPlayedCount]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updatePosition=function(t,e,a){try{var r=a||Date.now(),o=this.getOrCreate(t);return o.position=e,o.lastPlayed=r,o.lastUpdated=r,this.insert(o),o}catch(e){console.error("[LocalTrackInfoDb:updatePosition]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavorite=function(t,e,a){try{var r=a||Date.now(),o=this.getOrCreate(t);return o.favorite=e,o.lastUpdated=r,this.insert(o),this._toggleInFavoritesIndex(t,e),o}catch(e){console.error("[LocalTrackInfoDb:setFavorite]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavoritesByTrackIds=function(t,e){var a=this,r=e||Date.now();this._getIndex().forEach((function(e){var o=t.includes(e),i=a.getOrCreate(e);i.favorite!==o&&(i.favorite=o,i.lastUpdated=r,a.insert(i))})),this._setFavoritesIndex(t)},t.prototype.save=function(t,e){try{var a=e||Date.now();return t.lastPlayed=a,t.lastUpdated=a,this.insert(t),t}catch(e){console.error("[LocalTrackInfoDb:save]",e.message,{err:e,trackInfo:t});debugger;throw e}},t.prototype.createNewRecord=function(t){return{id:t,favorite:!1,playedCount:0,position:0,lastUpdated:Date.now(),lastPlayed:0}},t.prototype.getOrCreate=function(t){return this.getById(t)||this.createNewRecord(t)},t.prototype.insert=function(t){var e=t.id;window.localStorage.setItem("trackInfo-"+e,function(t){var e=t.id,a=t.favorite,r=t.playedCount,o=t.position,i=t.lastUpdated,n=t.lastPlayed,s=[e,Number(a),r,o,i,n];return JSON.stringify(s)}(t)),this._addToIndex(e)},t.prototype.getFavorites=function(){return this.getAll().filter((function(t){return t.favorite}))},t.prototype.getById=function(t){var e=window.localStorage.getItem("trackInfo-"+t);if(e)return function(t){if(t){var e=JSON.parse(t),a=e[0],r=e[1],o=e[2],i=e[3],n=e[4],s=e[5];return{id:a,favorite:Boolean(r),playedCount:o,position:i,lastUpdated:n,lastPlayed:s}}}(e)},t.prototype._getFavoritesIndex=function(){try{var t=window.localStorage.getItem("trackInfoFavoritesIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setFavoritesIndex=function(t){window.localStorage.setItem("trackInfoFavoritesIndex",JSON.stringify(t))},t.prototype._addToFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)||(e.push(t),this._setFavoritesIndex(e))},t.prototype._removeFromFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)&&this._setFavoritesIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInFavoritesIndex=function(t,e){e?this._addToFavoritesIndex(t):this._removeFromFavoritesIndex(t)},t.prototype._getIndex=function(){try{var t=window.localStorage.getItem("trackInfoIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setIndex=function(t){window.localStorage.setItem("trackInfoIndex",JSON.stringify(t))},t.prototype._addToIndex=function(t){var e=this._getIndex();e.includes(t)||(e.push(t),this._setIndex(e))},t.prototype._removeFromIndex=function(t){var e=this._getIndex();e.includes(t)&&this._setIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInIndex=function(t,e){e?this._addToIndex(t):this._removeFromIndex(t)},t.prototype.getAll=function(){var t=this;return this._getIndex().map((function(e){return t.getById(e)})).filter(Boolean)},t.prototype.delete=function(t){window.localStorage.removeItem("trackInfo-"+t),this._removeFromIndex(t)},t.prototype.clearAll=function(){this._getIndex().forEach((function(t){window.localStorage.removeItem("trackInfo-"+t)})),this._setIndex([])},t}());function o(t){var a=document.body.querySelector("#js-texts #"+t);return a||console.warn("[getJsText] Can not find js text node for id:",t),e((null==a?void 0:a.innerHTML)||t).trim()}var i={success:"bi-check",error:"bi-exclamation-triangle-fill",warn:"bi-bell-fill",info:"bi-info-lg"},n=new(function(){function e(){this.notifyRoot=void 0,this.timeoutDelay=3e3,this.inited=!1}return e.prototype.removeNotify=function(t){var e=this,a=t.node,r=t.handler;a.classList.remove("active"),r&&(clearTimeout(r),t.handler=void 0),setTimeout((function(){try{e.notifyRoot.removeChild(a)}catch(t){}}),250)},e.prototype.showNotify=function(e,a){var r,o=this;this.ensureInit(),a||(a=e,e="info"),r=a instanceof Error?t(a):String(a);var n=document.createElement("div");n.classList.add("notify"),n.classList.add("notify-"+e);var s=document.createElement("span");s.classList.add("icon"),s.classList.add("bi"),s.classList.add(i[e]),n.appendChild(s);var l=document.createElement("div");l.classList.add("text"),l.innerHTML=r,n.appendChild(l),this.notifyRoot.appendChild(n),window.requestAnimationFrame((function(){setTimeout((function(){n.classList.add("active")}),10)}));var c={node:n,handler:void 0},d=this.removeNotify.bind(this,c);c.handler=setTimeout(d,this.timeoutDelay),n.addEventListener("mouseenter",(function(){clearTimeout(c.handler)})),n.addEventListener("mouseleave",(function(){c.handler=setTimeout(d,o.timeoutDelay)})),n.addEventListener("click",d)},e.prototype.showInfo=function(t){this.showNotify("info",t)},e.prototype.showSuccess=function(t){this.showNotify("success",t)},e.prototype.showWarn=function(t){this.showNotify("warn",t)},e.prototype.showError=function(t){this.showNotify("error",t)},e.prototype.showDemo=function(){this.showInfo("Info"),this.showSuccess("Success"),this.showWarn("Warn"),this.showError("Error")},e.prototype.ensureInit=function(){this.init()},e.prototype.createDomNode=function(){var t=document.body,e=document.createElement("div");e.classList.add("notify-root"),e.setAttribute("id","notify-root"),t.appendChild(e),this.notifyRoot=e},e.prototype.init=function(){this.inited||(this.createDomNode(),this.inited=!0)},e}()),s="ActivePlayerData";function l(t){var e=t?function(t){return JSON.stringify(t)}(t):"";window.localStorage.setItem(s,e)}function c(){return function(t){return t?JSON.parse(t):void 0}(window.localStorage.getItem(s))}var d=function(t,e,a,r){return new(a||(a=Promise))((function(o,i){function n(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(n,s)}l((r=r.apply(t,e||[])).next())}))},u=function(t,e){var a,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},n=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return n.next=s(0),n.throw=s(1),n.return=s(2),"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(s){return function(l){return function(s){if(a)throw new TypeError("Generator is already executing.");for(;n&&(n=0,s[0]&&(i=0)),i;)try{if(a=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{a=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}};function h(e,a,r){var i=this;void 0===a&&(a="GET"),void 0===r&&(r=void 0);var n={Accept:"application/json","Content-Type":"application/json","X-CSRFToken":function(t){const e=document.cookie.split(";");for(let a=0;a<e.length;a++){const r=e[a],[o,i]=r.trim().split("=").map(decodeURIComponent);if(o===t)return i}}("csrftoken")};return fetch(e,{method:a,headers:n,credentials:"include",body:r&&JSON.stringify(r)}).then((function(t){return d(i,void 0,void 0,(function(){var i,s,l,c,d;return u(this,(function(u){switch(u.label){case 0:i=t.ok,s=t.status,l=t.statusText,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,t.json()];case 2:return c=u.sent(),[3,4];case 3:return u.sent(),[3,4];case 4:if(!i||200!==s){d=[o("fetchError")+" "+s,(null==c?void 0:c.detail)||l].filter(Boolean).join(": "),console.error("[sendApiRequest]",d,{ok:i,data:c,statusText:l,status:s,res:t,url:e,requestData:r,method:a,headers:n});debugger;throw new Error(d)}return[2,c]}}))}))})).catch((function(i){var s=[o("failedApiRequest"),t(i)].filter(Boolean).join(": ");console.error("[sendApiRequest]",s,{err:i,url:e,requestData:r,method:a,headers:n});debugger;throw new Error(s)}))}function p(t){return t?t.toFixed(2).replace(/\.0+$/,""):"0"}var y=function(){return y=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var o in e=arguments[a])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},y.apply(this,arguments)},f="FloatingPlayerState";function v(t){var e=y(y({},t),{lastTimestamp:Date.now()});delete e.error,delete e.loaded;var a=function(t){return JSON.stringify(t)}(e);window.localStorage.setItem(f,a)}function g(){return function(t){return t?JSON.parse(t):{}}(window.localStorage.getItem(f))}var m,P,k=function(){function t(){}return t.prototype.setParentDomNode=function(t){this.parentDomNode=t},t.prototype.requireParentDomNode=function(){return this.parentDomNode||document.body},t.prototype.ensureHiddenPlayer=function(){if(!this.hiddenPlayerNode){this.hiddenPlayerNode=document.createElement("div"),this.hiddenPlayerNode.classList.add("hidden-player");var t=document.createElement("audio");this.hiddenPlayerNode.appendChild(t),this.requireParentDomNode().appendChild(this.hiddenPlayerNode)}return this.hiddenPlayerNode},t.prototype.hasAudio=function(){return!!this.audioNode},t.prototype.hasSource=function(){return!!this.sourceNode},t.prototype.ensureHiddenPlayerAudio=function(){if(!this.audioNode){var t=this.requireParentDomNode();this.audioNode=document.createElement("audio"),this.audioNode.classList.add("hidden-player"),this.audioNode.setAttribute("preload","auto"),t.appendChild(this.audioNode)}return this.audioNode},t.prototype.createHiddenPlayerSource=function(t){void 0===t&&(t={}),this.removeHiddenPlayerSource();var e=this.ensureHiddenPlayerAudio();return this.sourceNode=document.createElement("source"),this.sourceNode.setAttribute("type",t.type||"audio/mpeg"),t.src&&this.sourceNode.setAttribute("src",t.src),e.appendChild(this.sourceNode),this.sourceNode},t.prototype.removeHiddenPlayerAudio=function(){this.audioNode&&(this.audioNode.pause(),this.audioNode.remove(),this.audioNode=void 0,this.sourceNode=void 0)},t.prototype.removeHiddenPlayerSource=function(){for(var t=this.ensureHiddenPlayerAudio(),e=0,a=Array.from(t.getElementsByTagName("source"));e<a.length;e++)a[e].remove();this.sourceNode=void 0},t}(),b=function(){function t(){this.onPlayStartCallbacks=[],this.onPlayStopCallbacks=[],this.onUpdateCallbacks=[],this.onIncrementCallbacks=[],this.onFavoritesCallbacks=[],this.onFavoriteCallbacks=[],this.onErrorCallbacks=[]}return t.prototype.addPlayStartCallback=function(t){t&&!this.onPlayStartCallbacks.includes(t)&&this.onPlayStartCallbacks.push(t)},t.prototype.addPlayStopCallback=function(t){t&&!this.onPlayStopCallbacks.includes(t)&&this.onPlayStopCallbacks.push(t)},t.prototype.addUpdateCallback=function(t){t&&!this.onUpdateCallbacks.includes(t)&&this.onUpdateCallbacks.push(t)},t.prototype.addIncrementCallback=function(t){t&&!this.onIncrementCallbacks.includes(t)&&this.onIncrementCallbacks.push(t)},t.prototype.addFavoriteCallback=function(t){t&&!this.onFavoriteCallbacks.includes(t)&&this.onFavoriteCallbacks.push(t)},t.prototype.addFavoritesCallback=function(t){t&&!this.onFavoritesCallbacks.includes(t)&&this.onFavoritesCallbacks.push(t)},t.prototype.addErrorCallback=function(t){t&&!this.onErrorCallbacks.includes(t)&&this.onErrorCallbacks.push(t)},t.prototype.invokePlayStart=function(t){t.activePlayerData&&this.onPlayStartCallbacks.forEach((function(e){e(t)}))},t.prototype.invokePlayStop=function(t){t.activePlayerData&&this.onPlayStopCallbacks.forEach((function(e){e(t)}))},t.prototype.invokeUpdate=function(t){t.activePlayerData&&this.onUpdateCallbacks.forEach((function(e){e(t)}))},t.prototype.invokeIncrement=function(t){t.activePlayerData&&this.onIncrementCallbacks.forEach((function(e){e(t)}))},t.prototype.invokeFavorite=function(t){this.onFavoriteCallbacks.forEach((function(e){e(t)}))},t.prototype.invokeFavorites=function(t){this.onFavoritesCallbacks.forEach((function(e){e(t)}))},t.prototype.invokeError=function(t){t&&this.onErrorCallbacks.forEach((function(e){e(t)}))},t}(),I="true",w=function(){function e(){this.inited=!1,this.callbacks=new b,this.hiddenPlayer=new k,this.state={},this.toggling={},this.seeking=!1,this.loadActivePlayerData(),this.loadFloatingPlayerState(),this.initDomNode(),this.updateAll();var t=Date.now();this.activePlayerData&&(this.ensureAudioLoaded(),"playing"===this.state.status&&this.state.lastTimestamp&&this.state.lastTimestamp>t-5e3?this.playCurrentPlayer():delete this.state.status)}return e.prototype.requireAudio=function(){return this.audio||(this.audio=this.hiddenPlayer.ensureHiddenPlayerAudio(),this.audio.addEventListener("canplay",this.handleAudioCanPlay.bind(this)),this.audio.addEventListener("playing",this.handleAudioPlay.bind(this)),this.audio.addEventListener("timeupdate",this.handleAudioTimeUpdate.bind(this)),this.audio.addEventListener("ended",this.handleAudioEnded.bind(this))),this.audio},e.prototype.removeAudio=function(){this.hiddenPlayer.removeHiddenPlayerAudio(),this.audio=void 0},e.prototype.hasAudio=function(){return!!this.audio},e.prototype.hasAudioSource=function(){return this.hiddenPlayer.hasSource()},e.prototype.requireDomNode=function(){if(this.domNode||(this.domNode=document.querySelector(".floating-player"),this.hiddenPlayer.setParentDomNode(this.domNode)),!this.domNode){var t=new Error("No floating player node found");console.error("[FloatingPlayerClass:requireDomNode]",t.message,{error:t});debugger;throw t}return this.domNode},e.prototype.requireActivePlayerData=function(){if(!this.activePlayerData){var t=new Error("No active player data set");console.error("[FloatingPlayerClass:requireActivePlayerData]",t.message,{error:t});debugger;throw t}return this.activePlayerData},e.prototype.loadActivePlayerData=function(){this.activePlayerData=c()},e.prototype.saveActivePlayerData=function(){l(this.activePlayerData)},e.prototype.loadFloatingPlayerState=function(){this.state=g()},e.prototype.saveFloatingPlayerState=function(){v(this.state)},e.prototype.showFloatingPlayer=function(){this.state.visible=!0,this.updateStateInDom(),this.saveFloatingPlayerState()},e.prototype.hideFloatingPlayer=function(){this.state.visible=!1,this.updateStateInDom(),this.saveFloatingPlayerState()},e.prototype.updateActivePlayerDataInDom=function(){var t=this.requireDomNode(),e=this.requireActivePlayerData(),r=e.id,o=t.querySelector(".title"),i=t.querySelector(".duration"),n=t.querySelector(".image"),s=t.dataset;requestAnimationFrame((function(){o.innerText=e.title,i.innerText=a(Math.floor(1e3*e.duration)),n.style.backgroundImage="url("+e.imageUrl+")",e.favorite?s.favorite=I:delete s.favorite,t.querySelectorAll(".trackLink").forEach((function(t){t.setAttribute("href","/tracks/".concat(r))}))}))},e.prototype.updateStateInDom=function(){var t=this,e=this.requireDomNode().dataset;requestAnimationFrame((function(){t.state.status?e.status=t.state.status:delete e.status,document.body.classList.toggle("withPlayer",!!t.state.visible)}))},e.prototype.updatePositionInDom=function(){var t=this,e=this.requireDomNode(),a=e.querySelector(".seekBar"),r=e.dataset;requestAnimationFrame((function(){r.position=p(t.state.position),r.progress=p(t.state.progress),e.style.setProperty("--progress",r.progress),a.value=r.progress}))},e.prototype.calculateProgress=function(){var t=this.requireActivePlayerData(),e=this.state.position,a=t.id,r=t.duration;if(!r){var o=new Error("No duration provided for a track: ".concat(a));console.error("[FloatingPlayerClass:calculateProgress]",o.message,{error:o});debugger;throw o}var i=e/r;return Math.min(100,100*i)},e.prototype.updateTrackPosition=function(){var t=this.requireDomNode().querySelector(".time"),e=this.requireActivePlayerData(),o=this.state.position,i=e.id,n=this.calculateProgress();this.state.progress=n,this.updatePositionInDom(),t&&requestAnimationFrame((function(){t.innerText=a(Math.floor(1e3*o))})),r.updatePosition(i,o)},e.prototype.updateAll=function(){this.activePlayerData&&this.updateTrackPosition(),this.updateStateInDom(),this.updatePositionInDom(),this.activePlayerData&&this.updateActivePlayerDataInDom()},e.prototype.handleAudioTimeUpdate=function(t){if(!this.seeking){var e=this.audio,a=t.currentTarget;if(a===e){var o=this.requireActivePlayerData(),i=a.currentTime;this.state.position!=i&&(this.state.position=i,this.updateTrackPosition(),this.saveFloatingPlayerState(),this.callbacks.invokeUpdate({floatingPlayerState:this.state,activePlayerData:o}),r.updatePosition(o.id,i))}}},e.prototype.handleAudioCanPlay=function(t){this.state.loaded||(this.state.loaded=!0,delete this.state.error)},e.prototype.handleAudioPlay=function(t){this.state.status="playing",this.updateStateInDom(),this.saveFloatingPlayerState(),this.callbacks.invokePlayStart({floatingPlayerState:this.state,activePlayerData:this.activePlayerData})},e.prototype.handleAudioEnded=function(t){this.incrementPlayedCount(),this.state.status="paused",this.updateStateInDom(),this.saveFloatingPlayerState(),this.callbacks.invokePlayStop({floatingPlayerState:this.state,activePlayerData:this.activePlayerData})},e.prototype.handleError=function(e){var a=e instanceof Error&&e.name;if(console.error("[FloatingPlayerClass:handleError]",{err:e}),"AbortError"!==a){debugger;this.state.error=t(e),this.updateStateInDom(),n.showError(e),this.callbacks.invokeError(e)}},e.prototype.handleAudioSourceError=function(t){var e=t.currentTarget,a=e.src,r=e.type,i=o("errorLoadingAudioFile")+" "+a+(r?"( ".concat(r,")"):""),n=new Error(i);this.handleError(n)},e.prototype.getActiveTrackId=function(){return this.activePlayerData?this.activePlayerData.id:void 0},e.prototype.loadAudio=function(){var t=this.requireActivePlayerData();this.state.loaded=!1,this.hiddenPlayer.createHiddenPlayerSource({src:t.mediaUrl}).addEventListener("error",this.handleAudioSourceError.bind(this))},e.prototype.isAudioPlaying=function(){var t=this.audio;return!!t&&t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2},e.prototype.isPlaying=function(){return"playing"===this.state.status},e.prototype.pauseCurrentPlayer=function(){this.isAudioPlaying()&&this.requireAudio().pause(),this.isPlaying()&&(this.state.status="paused",this.updateStateInDom(),this.saveFloatingPlayerState())},e.prototype.playCurrentPlayer=function(){var t=this,e=this.requireAudio(),a=this.requireActivePlayerData();this.isAudioPlaying()||((e.ended||this.state.position>a.duration-.1)&&(this.state.position=0,e.load()),this.updateTrackPosition(),this.callbacks.invokeUpdate({floatingPlayerState:this.state,activePlayerData:this.activePlayerData}),e.currentTime=this.state.position||0,e.play().catch((function(e){"NotAllowedError"===e.name?(t.state.status=void 0,t.updateStateInDom()):t.handleError(e)})))},e.prototype.trackPlayHandler=function(t){this.isPlaying()?this.pauseCurrentPlayer():this.playCurrentPlayer()},e.prototype.ensureAudioLoaded=function(){this.state.loaded&&this.hasAudio()&&this.hasAudioSource||this.loadAudio()},e.prototype.setActivePlayerData=function(t,e){var a;(null===(a=this.activePlayerData)||void 0===a?void 0:a.id)!==t.id&&(this.activePlayerData&&this.isPlaying&&this.pauseCurrentPlayer(),this.state.loaded=!1,null!=e&&(this.state.position=e),this.removeAudio(),this.activePlayerData=t),this.saveActivePlayerData(),this.updateActivePlayerDataInDom(),this.ensureAudioLoaded()},e.prototype.setActiveTrack=function(t,e){var a=function(t){var e=t.dataset,a=Number(e.trackId),r=Boolean(e.favorite),o=parseFloat((e.trackDuration||"0").replace(",",".")),i=e.trackMediaUrl,n=t.querySelector("img.card-img"),s=null==n?void 0:n.getAttribute("src"),l=t.querySelector(".post-title");return{id:a,title:null==l?void 0:l.innerHTML,imageUrl:s,mediaUrl:i,duration:o,favorite:r}}(t);this.setActivePlayerData(a,e)},e.prototype.clearActiveData=function(){this.activePlayerData=void 0,this.hideFloatingPlayer(),this.removeAudio()},e.prototype.sendIncrementPlayedCount=function(t){return h("/api/v1/tracks/".concat(t,"/increment-played-count/"),"POST")},e.prototype.incrementPlayedCount=function(){var t=this,e=this.requireActivePlayerData();if(!this.incrementing)return this.incrementing=!0,this.sendIncrementPlayedCount(e.id).then((function(a){var r=a.played_count;null!=r&&t.callbacks.invokeIncrement({count:r,activePlayerData:e})})).catch((function(a){console.error("[FloatingPlayerClass:incrementPlayedCount:sendIncrementPlayedCount] error",{err:a});debugger;throw n.showError(a),t.callbacks.invokeIncrement({activePlayerData:e}),a})).finally((function(){t.incrementing=!1}))},e.prototype.sendToggleFavoriteRequest=function(t,e){return h("/api/v1/tracks/".concat(t,"/toggle-favorite/"),"POST",{value:e})},e.prototype.toggleFavorite=function(){var t=this.requireActivePlayerData().id;this.toggleFavoriteById(t)},e.prototype.toggleFavoriteById=function(t){var e=this;if(!this.toggling[t]){var a=this.activePlayerData,i=t===(null==a?void 0:a.id),s=!r.getById(t).favorite;r.updateFavorite(t,s),i&&(a.favorite=s,this.updateActivePlayerDataInDom(),this.saveActivePlayerData()),this.callbacks.invokeFavorite({id:t,favorite:s}),window.isAuthenticated&&(this.toggling[t]=!0,this.sendToggleFavoriteRequest(t,s).then((function(t){var a=t.favorite_track_ids;r.updateFavoritesByTrackIds(a),e.callbacks.invokeFavorites({favorites:a});var i=s?"trackAddedToFavorites":"trackRemovedFromFavorites";n.showSuccess(o(i))})).catch((function(t){console.error("[FloatingPlayerClass:toggleFavoriteById] error",{err:t});debugger;n.showError(t)})).finally((function(){e.toggling[t]=!1})))}},e.prototype.seekPosition=function(t){var e=this;this.seeking=!0,this.requireAudio().currentTime=t||0,this.state.position=t,this.updateTrackPosition(),this.saveFloatingPlayerState();var a=this.requireActivePlayerData();this.callbacks.invokeUpdate({floatingPlayerState:this.state,activePlayerData:a}),setTimeout((function(){e.seeking=!1}),150)},e.prototype.seekRewind=function(){var t=Math.max(0,this.state.position-1);this.seekPosition(t)},e.prototype.seekForward=function(){var t=this.requireActivePlayerData().duration,e=Math.min(t,this.state.position+1);this.seekPosition(e)},e.prototype.seekBarHandle=function(t){var e=this.requireActivePlayerData().duration;if(e){var a=t.currentTarget,r=Number(a.value)*e/100;this.seekPosition(r),this.isPlaying()||this.playCurrentPlayer()}},e.prototype.initDomNode=function(){var t=this,e=this.requireDomNode(),a=e.querySelector(".seekBar");a&&a.addEventListener("input",this.seekBarHandle.bind(this));var r=e.querySelector(".track-control-hide");r&&r.addEventListener("click",this.hideFloatingPlayer.bind(this)),e.querySelectorAll(".track-control").forEach((function(e){var a=e.dataset,r=a.inited,o=a.controlId;r||("rewind"===o&&e.addEventListener("click",t.seekRewind.bind(t)),"forward"===o&&e.addEventListener("click",t.seekForward.bind(t)),"toggleFavorite"===o&&e.addEventListener("click",t.toggleFavorite.bind(t)),"play"===o&&e.addEventListener("click",t.trackPlayHandler.bind(t)),a.inited=I)})),this.inited=!0},e}(),D=new w,S=void 0,A="true";function F(t,e,o){var i=t.querySelector(".time"),n=t.dataset,s=n.trackId,l=n.trackDuration,c=a(Math.floor(1e3*e)),d=Number(s),u=parseFloat(l.replace(",","."));if(!u){var h=new Error("No duration provided for a track: ".concat(d));console.error("[tracksPlayer:updateTrackPosition]",h.message,{error:h});debugger}var y=e/u,f=Math.min(100,100*y);requestAnimationFrame((function(){n.position=p(e),n.progress=p(f),t.style.setProperty("--progress",n.progress),i&&(i.innerText=c)})),r.updatePosition(d,e)}function C(t){var e=t.floatingPlayerState,r=t.activePlayerData.id,o=S;if(o&&Number(o.dataset.trackId)===r||(o=q(r)),o){var i=e.position,n=e.progress,s=e.status,l=S.dataset,c=S.querySelector(".time"),d=a(Math.floor(1e3*i));requestAnimationFrame((function(){s?l.status=s:delete l.status,l.position=p(i),l.progress=p(n),S.style.setProperty("--progress",l.progress),c&&(c.innerText=d)})),F(o,i)}}function N(t){var e=t.activePlayerData;if(!S)throw new Error("No current track player node!");var a=S.dataset;if(Number(a.trackId)!==e.id)throw new Error("Wrong active track id!");a.status="playing"}function E(t){var e=t.activePlayerData;if(!S)throw new Error("No current track player node!");var a=S.dataset;if(Number(a.trackId)!==e.id)throw new Error("Wrong active track id!");a&&delete a.status}function q(t){return Array.from(m).find((function(e){return Number(e.dataset.trackId)===t}))}function T(t){var a=t.count,o=q(t.activePlayerData.id);o&&function(t,a){var o=t.dataset.trackId,i=Number(o);if(!i)throw new Error("No current track id!");var n=r.updatePlayedCount(i,a).playedCount,s=e(String(n)),l=t.querySelector("#played_count");if(l){var c=l.closest(".track-played-count[data-played-count]");requestAnimationFrame((function(){l.innerText=s,c&&(c.dataset.playedCount=s)}))}}(o,a)}function x(t){var e=t.currentTarget.closest(".track-player");S&&S!==e&&function(){if(S){var t=S.dataset;requestAnimationFrame((function(){S.classList.toggle("current",!1),delete t.status,delete t.loaded,delete t.error}))}}();var a=e.dataset,r=Number(a.trackId),o=D.getActiveTrackId(),i=D.isPlaying();if(!i||(D.pauseCurrentPlayer(),o!==r)){requestAnimationFrame((function(){e.classList.toggle("current",!0)})),S=e;var n=parseFloat((a.position||"0").replace(",","."));D.setActiveTrack(e,n),D.playCurrentPlayer(),i||D.showFloatingPlayer()}}function L(t,e){var a=t.dataset,r=a.favorite;e!==Boolean(r)&&(e?a.favorite=A:delete a.favorite)}function _(t){var e=t.id,a=t.favorite,r=q(e);r&&L(r,a)}function U(t){var e=t.favorites;m.forEach((function(t){var a=t.dataset.trackId,r=Number(a);L(t,e.includes(r))}))}function O(t){var e=D.activePlayerData,a=t.dataset,o=a.inited,i=a.trackId,n=a.trackMediaUrl,s=Number(i||"");if(s&&!o&&n){var l=r.getOrCreate(s);e&&e.id==s?(S=t,requestAnimationFrame((function(){t.classList.toggle("current",!0)})),C({floatingPlayerState:D.state,activePlayerData:e})):l.position&&F(t,l.position),window.isAuthenticated||(null==l?void 0:l.favorite)&&L(t,l.favorite),t.querySelectorAll(".track-control").forEach((function(t){var e=t.dataset,a=e.inited,r=e.controlId;a||("toggleFavorite"===r&&t.addEventListener("click",(function(){return D.toggleFavoriteById(s)})),"play"===r&&t.addEventListener("click",x),e.inited=A)})),a.inited=A}}void 0===P&&(P=document.body),(m=P.querySelectorAll(".track-player[data-track-media-url]")).forEach(O),D.callbacks.addPlayStartCallback(N),D.callbacks.addPlayStopCallback(E),D.callbacks.addUpdateCallback(C),D.callbacks.addIncrementCallback(T),D.callbacks.addFavoritesCallback(U),D.callbacks.addFavoriteCallback(_)})();
//# sourceMappingURL=scripts.js.map