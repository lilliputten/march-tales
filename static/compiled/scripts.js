(()=>{"use strict";function t(t){if(t)return Array.isArray(t)?t.map(this.getErrorText.bind(this)).join("\n"):(t instanceof Error?t=t.message:"string"!=typeof t&&(t=String(t)),t)}function e(t,e){const r=e?"&#13;":"\n";return String(t).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,r).replace(/[\r\n]/g,r)}function r(t){const e=t/1e3,r=e/60,o=r/60,a=[o/24,o%24,r%60,e%60].map(Math.floor).map(((t,e)=>{if(!(e<2)||t)return e>=1?String(t).padStart(2,"0"):e?void 0:String(t)+"d"}));return[a.shift(),a.filter(Boolean).join(":")].filter(Boolean).join(" ")}var o={success:"bi-check",error:"bi-exclamation-triangle-fill",warn:"bi-bell-fill",info:"bi-info-lg"},a=new(function(){function e(){this.notifyRoot=void 0,this.timeoutDelay=3e3,this.inited=!1}return e.prototype.removeNotify=function(t){var e=this,r=t.node,o=t.handler;r.classList.remove("active"),o&&(clearTimeout(o),t.handler=void 0),setTimeout((function(){try{e.notifyRoot.removeChild(r)}catch(t){}}),250)},e.prototype.showNotify=function(e,r){var a,i=this;this.ensureInit(),r||(r=e,e="info"),a=r instanceof Error?t(r):String(r);var n=document.createElement("div");n.classList.add("notify"),n.classList.add("notify-"+e);var s=document.createElement("span");s.classList.add("icon"),s.classList.add("bi"),s.classList.add(o[e]),n.appendChild(s);var d=document.createElement("div");d.classList.add("text"),d.innerHTML=a,n.appendChild(d),this.notifyRoot.appendChild(n),window.requestAnimationFrame((function(){setTimeout((function(){n.classList.add("active")}),10)}));var l={node:n,handler:void 0},c=this.removeNotify.bind(this,l);l.handler=setTimeout(c,this.timeoutDelay),n.addEventListener("mouseenter",(function(){clearTimeout(l.handler)})),n.addEventListener("mouseleave",(function(){l.handler=setTimeout(c,i.timeoutDelay)})),n.addEventListener("click",c)},e.prototype.showInfo=function(t){this.showNotify("info",t)},e.prototype.showSuccess=function(t){this.showNotify("success",t)},e.prototype.showWarn=function(t){this.showNotify("warn",t)},e.prototype.showError=function(t){this.showNotify("error",t)},e.prototype.showDemo=function(){this.showInfo("Info"),this.showSuccess("Success"),this.showWarn("Warn"),this.showError("Error")},e.prototype.ensureInit=function(){this.init()},e.prototype.createDomNode=function(){var t=document.body,e=document.createElement("div");e.classList.add("notify-root"),e.setAttribute("id","notify-root"),t.appendChild(e),this.notifyRoot=e},e.prototype.init=function(){this.inited||(this.createDomNode(),this.inited=!0)},e}());function i(t){var r=document.body.querySelector("#js-texts #"+t);return r||console.warn("[getJsText] Can not find js text node for id:",t),e((null==r?void 0:r.innerHTML)||t).trim()}var n=function(t,e,r,o){return new(r||(r=Promise))((function(a,i){function n(t){try{d(o.next(t))}catch(t){i(t)}}function s(t){try{d(o.throw(t))}catch(t){i(t)}}function d(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(n,s)}d((o=o.apply(t,e||[])).next())}))},s=function(t,e){var r,o,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},n=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return n.next=s(0),n.throw=s(1),n.return=s(2),"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(s){return function(d){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;n&&(n=0,s[0]&&(i=0)),i;)try{if(r=1,o&&(a=2&s[0]?o.return:s[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,s[1])).done)return a;switch(o=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!((a=(a=i.trys).length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],o=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,d])}}};function d(e,r,o){var a=this;void 0===r&&(r="GET"),void 0===o&&(o=void 0);var d={Accept:"application/json","Content-Type":"application/json","X-CSRFToken":function(t){const e=document.cookie.split(";");for(let r=0;r<e.length;r++){const o=e[r],[a,i]=o.trim().split("=").map(decodeURIComponent);if(a===t)return i}}("csrftoken")};return fetch(e,{method:r,headers:d,credentials:"include",body:o&&JSON.stringify(o)}).then((function(t){return n(a,void 0,void 0,(function(){var a,n,l,c,u;return s(this,(function(s){switch(s.label){case 0:a=t.ok,n=t.status,l=t.statusText,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t.json()];case 2:return c=s.sent(),[3,4];case 3:return s.sent(),[3,4];case 4:if(!a||200!==n){u=[i("fetchError")+" "+n,(null==c?void 0:c.detail)||l].filter(Boolean).join(": "),console.error("[sendApiRequest]",u,{ok:a,data:c,statusText:l,status:n,res:t,url:e,requestData:o,method:r,headers:d});debugger;throw new Error(u)}return[2,c]}}))}))})).catch((function(a){var n=[i("failedApiRequest"),t(a)].filter(Boolean).join(": ");console.error("[sendApiRequest]",n,{err:a,url:e,requestData:o,method:r,headers:d});debugger;throw new Error(n)}))}var l=new(function(){function t(){}return t.prototype.updatePlayedCount=function(t,e,r){try{var o=r||Date.now(),a=this.getOrCreate(t);return isNaN(e)?a.playedCount=a.playedCount?a.playedCount+1:1:a.playedCount=e,a.lastPlayed=o,a.lastUpdated=o,this.insert(a),a}catch(e){console.error("[LocalTrackInfoDb:incrementPlayedCount]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updatePosition=function(t,e,r){try{var o=r||Date.now(),a=this.getOrCreate(t);return a.position=e,a.lastPlayed=o,a.lastUpdated=o,this.insert(a),a}catch(e){console.error("[LocalTrackInfoDb:updatePosition]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavorite=function(t,e,r){try{var o=r||Date.now(),a=this.getOrCreate(t);return a.favorite=e,a.lastUpdated=o,this.insert(a),this._toggleInFavoritesIndex(t,e),a}catch(e){console.error("[LocalTrackInfoDb:setFavorite]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavoritesByTrackIds=function(t,e){var r=this,o=e||Date.now();this._getIndex().forEach((function(e){var a=t.includes(e),i=r.getOrCreate(e);i.favorite!==a&&(i.favorite=a,i.lastUpdated=o,r.insert(i))})),this._setFavoritesIndex(t)},t.prototype.save=function(t,e){try{var r=e||Date.now();return t.lastPlayed=r,t.lastUpdated=r,this.insert(t),t}catch(e){console.error("[LocalTrackInfoDb:save]",e.message,{err:e,trackInfo:t});debugger;throw e}},t.prototype.createNewRecord=function(t){return{id:t,favorite:!1,playedCount:0,position:0,lastUpdated:Date.now(),lastPlayed:0}},t.prototype.getOrCreate=function(t){return this.getById(t)||this.createNewRecord(t)},t.prototype.insert=function(t){var e=t.id;window.localStorage.setItem("trackInfo-"+e,function(t){var e=t.id,r=t.favorite,o=t.playedCount,a=t.position,i=t.lastUpdated,n=t.lastPlayed,s=[e,Number(r),o,a,i,n];return JSON.stringify(s)}(t)),this._addToIndex(e)},t.prototype.getFavorites=function(){return this.getAll().filter((function(t){return t.favorite}))},t.prototype.getById=function(t){var e=window.localStorage.getItem("trackInfo-"+t);if(e)return function(t){if(t){var e=JSON.parse(t),r=e[0],o=e[1],a=e[2],i=e[3],n=e[4],s=e[5];return{id:r,favorite:Boolean(o),playedCount:a,position:i,lastUpdated:n,lastPlayed:s}}}(e)},t.prototype._getFavoritesIndex=function(){try{var t=window.localStorage.getItem("trackInfoFavoritesIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setFavoritesIndex=function(t){window.localStorage.setItem("trackInfoFavoritesIndex",JSON.stringify(t))},t.prototype._addToFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)||(e.push(t),this._setFavoritesIndex(e))},t.prototype._removeFromFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)&&this._setFavoritesIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInFavoritesIndex=function(t,e){e?this._addToFavoritesIndex(t):this._removeFromFavoritesIndex(t)},t.prototype._getIndex=function(){try{var t=window.localStorage.getItem("trackInfoIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setIndex=function(t){window.localStorage.setItem("trackInfoIndex",JSON.stringify(t))},t.prototype._addToIndex=function(t){var e=this._getIndex();e.includes(t)||(e.push(t),this._setIndex(e))},t.prototype._removeFromIndex=function(t){var e=this._getIndex();e.includes(t)&&this._setIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInIndex=function(t,e){e?this._addToIndex(t):this._removeFromIndex(t)},t.prototype.getAll=function(){var t=this;return this._getIndex().map((function(e){return t.getById(e)})).filter(Boolean)},t.prototype.delete=function(t){window.localStorage.removeItem("trackInfo-"+t),this._removeFromIndex(t)},t.prototype.clearAll=function(){this._getIndex().forEach((function(t){window.localStorage.removeItem("trackInfo-"+t)})),this._setIndex([])},t}()),c="ActivePlayerData";function u(t){var e=t?function(t){return JSON.stringify(t)}(t):"";window.localStorage.setItem(c,e)}function p(){return function(t){return t?JSON.parse(t):void 0}(window.localStorage.getItem(c))}var h=function(){return h=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},h.apply(this,arguments)},y="FloatingPlayerState";function f(t){var e=h(h({},t),{lastTimestamp:Date.now()});delete e.error,delete e.loaded;var r=function(t){return JSON.stringify(t)}(e);window.localStorage.setItem(y,r)}function v(){return function(t){return t?JSON.parse(t):{}}(window.localStorage.getItem(y))}var g=function(){function t(){}return t.prototype.setParentDomNode=function(t){this.parentDomNode=t},t.prototype.requireParentDomNode=function(){return this.parentDomNode||document.body},t.prototype.ensureHiddenPlayer=function(){if(!this.hiddenPlayerNode){this.hiddenPlayerNode=document.createElement("div"),this.hiddenPlayerNode.classList.add("hidden-player");var t=document.createElement("audio");this.hiddenPlayerNode.appendChild(t),this.requireParentDomNode().appendChild(this.hiddenPlayerNode)}return this.hiddenPlayerNode},t.prototype.hasAudio=function(){return!!this.audioNode},t.prototype.hasSource=function(){return!!this.sourceNode},t.prototype.ensureHiddenPlayerAudio=function(){if(!this.audioNode){var t=this.requireParentDomNode();this.audioNode=document.createElement("audio"),this.audioNode.classList.add("hidden-player"),this.audioNode.setAttribute("preload","auto"),t.appendChild(this.audioNode)}return this.audioNode},t.prototype.createHiddenPlayerSource=function(t){void 0===t&&(t={}),this.removeHiddenPlayerSource();var e=this.ensureHiddenPlayerAudio();return this.sourceNode=document.createElement("source"),this.sourceNode.setAttribute("type",t.type||"audio/mpeg"),t.src&&this.sourceNode.setAttribute("src",t.src),e.appendChild(this.sourceNode),this.sourceNode},t.prototype.removeHiddenPlayerAudio=function(){this.audioNode&&(this.audioNode.pause(),this.audioNode.remove(),this.audioNode=void 0,this.sourceNode=void 0)},t.prototype.removeHiddenPlayerSource=function(){for(var t=this.ensureHiddenPlayerAudio(),e=0,r=Array.from(t.getElementsByTagName("source"));e<r.length;e++)r[e].remove();this.sourceNode=void 0},t}(),m=function(){function t(){this.onPlayStartCallbacks=[],this.onPlayStopCallbacks=[],this.onUpdateCallbacks=[],this.onErrorCallbacks=[]}return t.prototype.addPlayStartCallback=function(t){t&&!this.onPlayStartCallbacks.includes(t)&&this.onPlayStartCallbacks.push(t)},t.prototype.addPlayStopCallback=function(t){t&&!this.onPlayStopCallbacks.includes(t)&&this.onPlayStopCallbacks.push(t)},t.prototype.addUpdateCallback=function(t){t&&!this.onUpdateCallbacks.includes(t)&&this.onUpdateCallbacks.push(t)},t.prototype.addErrorCallback=function(t){t&&!this.onErrorCallbacks.includes(t)&&this.onErrorCallbacks.push(t)},t.prototype.invokePlayStartCallbacks=function(t,e){e&&this.onPlayStartCallbacks.forEach((function(r){r(t,e)}))},t.prototype.invokePlayStopCallbacks=function(t,e){e&&this.onPlayStopCallbacks.forEach((function(r){r(t,e)}))},t.prototype.invokeUpdateCallbacks=function(t,e){e&&this.onUpdateCallbacks.forEach((function(r){r(t,e)}))},t.prototype.invokeErrorCallbacks=function(t){t&&this.onErrorCallbacks.forEach((function(e){e(t)}))},t}(),P=function(){function e(){this.inited=!1,this.callbacks=new m,this.hiddenPlayer=new g,this.state={},this.loadActivePlayerData(),this.loadFloatingPlayerState(),this.initTrackDomNode(),this.updateAll(),Date.now(),this.activePlayerData&&"playing"===this.state.status&&this.state.lastTimestamp?console.log("[FloatingPlayerClass:constructor] Start play",{activePlayerData:this.activePlayerData,state:this.state}):delete this.state.status}return e.prototype.requireAudio=function(){return this.audio||(this.audio=this.hiddenPlayer.ensureHiddenPlayerAudio(),this.audio.addEventListener("canplay",this.handleAudioCanPlay.bind(this)),this.audio.addEventListener("playing",this.handleAudioPlay.bind(this)),this.audio.addEventListener("timeupdate",this.handleAudioTimeUpdate.bind(this)),this.audio.addEventListener("ended",this.handleAudioEnded.bind(this))),this.audio},e.prototype.removeAudio=function(){this.hiddenPlayer.removeHiddenPlayerAudio(),this.audio=void 0},e.prototype.hasAudio=function(){return!!this.audio},e.prototype.hasAudioSource=function(){return this.hiddenPlayer.hasSource()},e.prototype.requireDomNode=function(){if(this.domNode||(this.domNode=document.querySelector(".floating-player"),this.hiddenPlayer.setParentDomNode(this.domNode)),!this.domNode){var t=new Error("No floating player node found");console.error("[FloatingPlayerClass:requireDomNode]",t.message,{error:t});debugger;throw t}return this.domNode},e.prototype.requireActivePlayerData=function(){if(!this.activePlayerData){var t=new Error("No active player data set");console.error("[FloatingPlayerClass:requireActivePlayerData]",t.message,{error:t});debugger;throw t}return this.activePlayerData},e.prototype.loadActivePlayerData=function(){this.activePlayerData=p()},e.prototype.saveActivePlayerData=function(){u(this.activePlayerData)},e.prototype.loadFloatingPlayerState=function(){this.state=v()},e.prototype.saveFloatingPlayerState=function(){f(this.state)},e.prototype.showFloatingPlayer=function(){this.state.visible=!0,this.updateStateInDom(),this.saveFloatingPlayerState()},e.prototype.hideFloatingPlayer=function(){this.state.visible=!1,this.updateStateInDom(),this.saveFloatingPlayerState()},e.prototype.updateActivePlayerDataInDom=function(){var t=this.requireDomNode(),e=this.requireActivePlayerData();t.querySelector(".title").innerText=e.title,t.querySelector(".image").style.backgroundImage="url("+e.imageUrl+")"},e.prototype.updateStateInDom=function(){var t=this.requireDomNode().dataset;this.state.status?t.status=this.state.status:delete t.status,document.body.classList.toggle("withPlayer",!!this.state.visible)},e.prototype.updatePositionInDom=function(){var t=this.requireDomNode(),e=t.dataset;e.position=String(this.state.position||0),e.progress=String(this.state.progress||0),t.style.setProperty("--progress",String(this.state.progress||0))},e.prototype.calculateProgress=function(){var t=this.requireActivePlayerData(),e=this.state.position,r=t.id,o=t.duration;if(!o){var a=new Error("No duration provided for a track: ".concat(r));console.error("[FloatingPlayerClass:calculateProgress]",a.message,{error:a});debugger;throw a}var i=e/o;return Math.round(100*i)},e.prototype.updateTrackPosition=function(){var t=this.requireDomNode().querySelector(".time"),e=this.requireActivePlayerData(),o=this.state.position,a=e.id,i=this.calculateProgress();this.state.progress=i,this.updatePositionInDom(),t&&(t.innerHTML=r(Math.floor(1e3*o))),l.updatePosition(a,o)},e.prototype.updateAll=function(){this.updateStateInDom(),this.updatePositionInDom(),this.activePlayerData&&this.updateActivePlayerDataInDom()},e.prototype.handleAudioTimeUpdate=function(t){var e=this.audio,r=t.currentTarget;if(r===e){var o=r.getElementsByTagName("SOURCE")[0],a=r.currentTime,i=r.readyState,n=this.requireActivePlayerData();console.log("[FloatingPlayerClass:handleAudioTimeUpdate]",{currentTime:a,readyState:i,id:n.id,activePlayerData:n,src:o.src,source:o,thisAudio:e===r,currAudio:e,audio:r}),this.state.position!=a&&(this.state.position=a,this.updateTrackPosition(),this.callbacks.invokeUpdateCallbacks(this.state,n))}},e.prototype.handleAudioCanPlay=function(t){if(!this.state.loaded){var e=t.currentTarget,r=e.getElementsByTagName("SOURCE")[0],o=null==r?void 0:r.src;console.log("[FloatingPlayerClass:sharedPlayerCanPlay]",{src:o,source:r,audio:e,ev:t}),this.state.loaded=!0,delete this.state.error}},e.prototype.handleAudioPlay=function(t){console.log("[FloatingPlayerClass:handleAudioPlay]"),this.state.status="playing",this.updateStateInDom(),this.saveFloatingPlayerState(),this.callbacks.invokePlayStartCallbacks(this.state,this.activePlayerData)},e.prototype.handleAudioEnded=function(t){console.log("[FloatingPlayerClass:handleAudioEnded]"),this.state.status="paused",this.updateStateInDom(),this.saveFloatingPlayerState(),this.callbacks.invokePlayStopCallbacks(this.state,this.activePlayerData)},e.prototype.handleAudioSourceError=function(e){var r=e.currentTarget,o=r.src,n=r.type,s=i("errorLoadingAudioFile")+" "+o,d=new Error(s);console.error("[FloatingPlayerClass:handleAudioSourceError]",s,{error:d,src:o,type:n,ev:e});debugger;a.showError(s),this.state.error=t(d),this.callbacks.invokeErrorCallbacks(d)},e.prototype.getActiveTrackId=function(){return this.activePlayerData?this.activePlayerData.id:void 0},e.prototype.loadAudio=function(){var t=this.requireActivePlayerData();console.log("[FloatingPlayerClass:loadAudio]",{mediaUrl:t.mediaUrl,id:t.id}),this.state.loaded=!1,this.hiddenPlayer.createHiddenPlayerSource({src:t.mediaUrl}).addEventListener("error",this.handleAudioSourceError.bind(this))},e.prototype.isAudioPlaying=function(){var t=this.audio;return!!t&&t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2},e.prototype.isPlaying=function(){return"playing"===this.state.status},e.prototype.pauseCurrentPlayer=function(){this.isAudioPlaying()&&this.requireAudio().pause(),this.isPlaying()&&(this.state.status="paused",this.updateStateInDom(),this.saveFloatingPlayerState())},e.prototype.playCurrentPlayer=function(){var t=this.requireAudio(),e=this.requireActivePlayerData();this.isAudioPlaying()||((t.ended||this.state.position>e.duration-.1)&&(this.state.position=0),this.updateTrackPosition(),this.callbacks.invokeUpdateCallbacks(this.state,this.activePlayerData),t.currentTime=this.state.position||0,t.play())},e.prototype.trackPlayHandler=function(t){this.isPlaying()?this.pauseCurrentPlayer():this.playCurrentPlayer()},e.prototype.ensureAudioLoaded=function(){this.state.loaded&&this.hasAudio()&&this.hasAudioSource||this.loadAudio()},e.prototype.setActivePlayerData=function(t,e){var r;(null===(r=this.activePlayerData)||void 0===r?void 0:r.id)!==t.id&&(this.activePlayerData&&this.isPlaying&&this.pauseCurrentPlayer(),this.state.loaded=!1,null!=e&&(this.state.position=e),this.removeAudio(),console.log("[FloatingPlayerClass:setActivePlayerData]",t),this.activePlayerData=t),this.saveActivePlayerData(),this.updateActivePlayerDataInDom(),this.ensureAudioLoaded()},e.prototype.setActiveTrack=function(t,e){var r=function(t){var e=t.dataset,r=Number(e.trackId),o=parseFloat((e.trackDuration||"0").replace(",",".")),a=e.trackMediaUrl,i=t.querySelector("img.card-img"),n=null==i?void 0:i.getAttribute("src"),s=t.querySelector(".post-title"),d=null==s?void 0:s.innerHTML,l={id:r,title:d,imageUrl:n,mediaUrl:a,duration:o};return console.log("[getActivePlayerDataFromTrackNode]",{activePlayerData:l,id:r,duration:o,mediaUrl:a,imageUrl:n,trackNode:t,title:d}),l}(t);this.setActivePlayerData(r,e)},e.prototype.setPosition=function(t){this.state.position=t},e.prototype.clearActiveData=function(){this.activePlayerData=void 0,this.hideFloatingPlayer(),this.removeAudio()},e.prototype.initTrackDomNode=function(){var t=this;this.requireDomNode().querySelectorAll(".track-control").forEach((function(e){var r=e.dataset,o=r.inited,a=r.controlId;o||("play"===a&&e.addEventListener("click",t.trackPlayHandler.bind(t)),r.inited="true")})),this.inited=!0},e}(),k=new P;document.body;var b,w,S=void 0,I=void 0,N="true";function A(t,e,o){var a=t.querySelector(".time"),i=t.dataset,n=i.trackId,s=i.trackDuration,d=r(Math.floor(1e3*e)),c=Number(n),u=parseFloat(s.replace(",","."));if(!u){var p=new Error("No duration provided for a track: ".concat(c));console.error("[tracksPlayer:updateTrackPosition]",p.message,{error:p});debugger}var h=e/u,y=Math.round(100*h);i.position=String(e),i.progress=String(y),t.style.setProperty("--progress",String(y)),a&&(a.innerHTML=d),l.updatePosition(c,e)}function D(t,e){if(!I)throw new Error("No current track player node!");var r=I.dataset;if(Number(r.trackId)!==e.id)throw new Error("Wrong active track id!");r.status="playing"}function C(t,e){if(!I)throw new Error("No current track player node!");var r=I.dataset;if(Number(r.trackId)!==e.id)throw new Error("Wrong active track id!");r&&delete r.status,F()}function E(t,e){var o=e.id,a=I;if(a&&Number(a.dataset.trackId)===o||(a=function(t){return Array.from(b).find((function(e){return Number(e.dataset.trackId)===t}))}(o)),a){var i=a===I,n=t.position,s=t.progress,d=t.status,c=I.dataset,u=I.querySelector(".time"),p=Math.floor(1e3*n),h=r(p);console.log("[tracksPlayer:floatingPlayerUpdate]",{id:o,status:d,position:n,progress:s,timeMs:p,timeFormatted:h,timeNode:u,dataset:c,currentTrackPlayer:I,isCurrent:i}),d?c.status=d:delete c.status,c.position=String(n),c.progress=String(s),I.style.setProperty("--progress",String(s)),u&&(u.innerHTML=h),l.updatePosition(o,n)}}function T(t,r,o){var a=t.dataset.trackId,i=Number(a);if(!i)throw new Error("No current track id!");var n=l.updatePlayedCount(i,r).playedCount,s=e(String(n)),d=t.querySelector("#played_count");if(d){d.innerText=s;var c=d.closest(".track-played-count[data-played-count]");c&&(c.dataset.playedCount=s)}}function F(){if(!I)throw new Error("No current track player node!");var t=I,e=t.dataset;if(!e.incrementing){var r;if(e.incrementing=N,T(t,void 0),window.isAuthenticated)return(r=I.dataset.trackId,d("/api/v1/tracks/".concat(r,"/increment-played-count/"),"POST")).then((function(e){var r=e.played_count;null!=r&&T(t,r)})).catch((function(t){console.error("[tracksPlayer:incrementPlayedCount:sendIncrementPlayedCount] error",{err:t});debugger;throw a.showError(t),t})).finally((function(){delete e.incrementing}));delete e.incrementing}}function x(t){var e=t.currentTarget.closest(".track-player");I&&I!==e&&function(){if(S){var t=S.getElementsByTagName("audio")[0];t&&function(t){return!!t&&t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2}(t)&&t.pause()}if(I){I.classList.toggle("current",!1);var e=I.dataset;delete e.status,delete e.loaded,delete e.error}}();var r=e.dataset,o=Number(r.trackId),a=k.getActiveTrackId(),i=k.isPlaying();if(!i||(k.pauseCurrentPlayer(),a!==o)){e.classList.toggle("current",!0),I=e;var n=parseFloat((r.position||"0").replace(",","."));k.setActiveTrack(e,n),k.playCurrentPlayer(),i||k.showFloatingPlayer()}}function q(t,e){var r=t.dataset,o=r.favorite;e!==Boolean(o)&&(e?r.favorite=N:delete r.favorite)}function L(t){var e=t.currentTarget.closest(".track-player").dataset,r=e.trackId,o=e.favorite,n=Number(r);if(!n)throw new Error("No current track id!");var s=!o;l.updateFavorite(n,s),s?e.favorite=N:delete e.favorite,window.isAuthenticated&&function(t,e){return d("/api/v1/tracks/".concat(t,"/toggle-favorite/"),"POST",{value:e})}(r,s).then((function(t){var e,r=t.favorite_track_ids;e=r,l.updateFavoritesByTrackIds(e),b.forEach((function(t){var r=t.dataset.trackId,o=Number(r);q(t,e.includes(o))}));var o=s?"trackAddedToFavorites":"trackRemovedFromFavorites";a.showSuccess(i(o))})).catch((function(t){console.error("[tracksPlayer:toggleFavorite:sendToggleFavoriteRequest] error",{err:t});debugger;a.showError(t)}))}function U(t){var e=k.activePlayerData,r=t.dataset,o=r.inited,a=r.trackId,i=r.trackMediaUrl,n=Number(a||"");if(n&&!o&&i){var s=l.getById(n);if(e&&e.id==n)I=t,t.classList.toggle("current",!0),E(k.state,e);else if(s){var d=s.position;d&&A(t,d)}s&&(window.isAuthenticated||(null==s?void 0:s.favorite)&&q(t,s.favorite)),t.querySelectorAll(".track-control").forEach((function(t){var e=t.dataset,r=e.inited,o=e.controlId;r||("toggleFavorite"===o&&t.addEventListener("click",L),"play"===o&&t.addEventListener("click",x),e.inited=N)})),r.inited=N}}void 0===w&&(w=document.body),(b=w.querySelectorAll(".track-player[data-track-media-url]")).forEach(U),k.callbacks.addPlayStartCallback(D),k.callbacks.addPlayStopCallback(C),k.callbacks.addUpdateCallback(E)})();
//# sourceMappingURL=scripts.js.map