(()=>{"use strict";function t(t){if(t)return Array.isArray(t)?t.map(this.getErrorText.bind(this)).join("\n"):(t instanceof Error?t=t.message:"string"!=typeof t&&(t=String(t)),t)}function e(t,e){const r=e?"&#13;":"\n";return String(t).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,r).replace(/[\r\n]/g,r)}var r={success:"bi-check",error:"bi-exclamation-triangle-fill",warn:"bi-bell-fill",info:"bi-info-lg"},o=new(function(){function e(){this.notifyRoot=void 0,this.timeoutDelay=3e3,this.inited=!1}return e.prototype.removeNotify=function(t){var e=this,r=t.node,o=t.handler;r.classList.remove("active"),o&&(clearTimeout(o),t.handler=void 0),setTimeout((function(){try{e.notifyRoot.removeChild(r)}catch(t){}}),250)},e.prototype.showNotify=function(e,o){var n,a=this;this.ensureInit(),o||(o=e,e="info"),n=o instanceof Error?t(o):String(o);var i=document.createElement("div");i.classList.add("notify"),i.classList.add("notify-"+e);var s=document.createElement("span");s.classList.add("icon"),s.classList.add("bi"),s.classList.add(r[e]),i.appendChild(s);var d=document.createElement("div");d.classList.add("text"),d.innerHTML=n,i.appendChild(d),this.notifyRoot.appendChild(i),window.requestAnimationFrame((function(){setTimeout((function(){i.classList.add("active")}),10)}));var c={node:i,handler:void 0},u=this.removeNotify.bind(this,c);c.handler=setTimeout(u,this.timeoutDelay),i.addEventListener("mouseenter",(function(){clearTimeout(c.handler)})),i.addEventListener("mouseleave",(function(){c.handler=setTimeout(u,a.timeoutDelay)})),i.addEventListener("click",u)},e.prototype.showInfo=function(t){this.showNotify("info",t)},e.prototype.showSuccess=function(t){this.showNotify("success",t)},e.prototype.showWarn=function(t){this.showNotify("warn",t)},e.prototype.showError=function(t){this.showNotify("error",t)},e.prototype.showDemo=function(){this.showInfo("Info"),this.showSuccess("Success"),this.showWarn("Warn"),this.showError("Error")},e.prototype.ensureInit=function(){this.init()},e.prototype.createDomNode=function(){var t=document.body,e=document.createElement("div");e.classList.add("notify-root"),e.setAttribute("id","notify-root"),t.appendChild(e),this.notifyRoot=e},e.prototype.init=function(){this.inited||(this.createDomNode(),this.inited=!0)},e}());function n(t){var r=document.body.querySelector("#js-texts #"+t);return r||console.warn("[getJsText] Can not find js text node for id:",t),e((null==r?void 0:r.innerHTML)||t).trim()}var a=function(t,e,r,o){return new(r||(r=Promise))((function(n,a){function i(t){try{d(o.next(t))}catch(t){a(t)}}function s(t){try{d(o.throw(t))}catch(t){a(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,s)}d((o=o.apply(t,e||[])).next())}))},i=function(t,e){var r,o,n,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=s(0),i.throw=s(1),i.return=s(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(d){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(r=1,o&&(n=2&s[0]?o.return:s[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,s[1])).done)return n;switch(o=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((n=(n=a.trys).length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){a.label=s[1];break}if(6===s[0]&&a.label<n[1]){a.label=n[1],n=s;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(s);break}n[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,d])}}};function s(e,r,o){var s=this;void 0===r&&(r="GET"),void 0===o&&(o=void 0);var d={Accept:"application/json","Content-Type":"application/json","X-CSRFToken":function(t){const e=document.cookie.split(";");for(let r=0;r<e.length;r++){const o=e[r],[n,a]=o.trim().split("=").map(decodeURIComponent);if(n===t)return a}}("csrftoken")};return fetch(e,{method:r,headers:d,credentials:"include",body:o&&JSON.stringify(o)}).then((function(t){return a(s,void 0,void 0,(function(){var a,s,c,u,l;return i(this,(function(i){switch(i.label){case 0:a=t.ok,s=t.status,c=t.statusText,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t.json()];case 2:return u=i.sent(),[3,4];case 3:return i.sent(),[3,4];case 4:if(!a||200!==s){l=[n("fetchError")+" "+s,(null==u?void 0:u.detail)||c].filter(Boolean).join(": "),console.error("[sendApiRequest]",l,{ok:a,data:u,statusText:c,status:s,res:t,url:e,requestData:o,method:r,headers:d});debugger;throw new Error(l)}return[2,u]}}))}))})).catch((function(a){var i=[n("failedApiRequest"),t(a)].filter(Boolean).join(": ");console.error("[sendApiRequest]",i,{err:a,url:e,requestData:o,method:r,headers:d});debugger;throw new Error(i)}))}var d,c,u=new(function(){function t(){}return t.prototype.updatePlayedCount=function(t,e,r){try{var o=r||Date.now(),n=this.getOrCreate(t);return isNaN(e)?n.playedCount=n.playedCount?n.playedCount+1:1:n.playedCount=e,n.lastPlayed=o,n.lastUpdated=o,this.insert(n),n}catch(e){console.error("[LocalTrackInfoDb:incrementPlayedCount]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updatePosition=function(t,e,r){try{var o=r||Date.now(),n=this.getOrCreate(t);return n.position=e,n.lastPlayed=o,n.lastUpdated=o,this.insert(n),n}catch(e){console.error("[LocalTrackInfoDb:updatePosition]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavorite=function(t,e,r){try{var o=r||Date.now(),n=this.getOrCreate(t);return n.favorite=e,n.lastUpdated=o,this.insert(n),this._toggleInFavoritesIndex(t,e),n}catch(e){console.error("[LocalTrackInfoDb:setFavorite]",e.message,{err:e,id:t});debugger;throw e}},t.prototype.updateFavoritesByTrackIds=function(t,e){var r=this,o=e||Date.now();this._getIndex().forEach((function(e){var n=t.includes(e),a=r.getOrCreate(e);a.favorite!==n&&(a.favorite=n,a.lastUpdated=o,r.insert(a))})),this._setFavoritesIndex(t)},t.prototype.save=function(t,e){try{var r=e||Date.now();return t.lastPlayed=r,t.lastUpdated=r,this.insert(t),t}catch(e){console.error("[LocalTrackInfoDb:save]",e.message,{err:e,trackInfo:t});debugger;throw e}},t.prototype.createNewRecord=function(t){return{id:t,favorite:!1,playedCount:0,position:0,lastUpdated:Date.now(),lastPlayed:0}},t.prototype.getOrCreate=function(t){return this.getById(t)||this.createNewRecord(t)},t.prototype.insert=function(t){var e=t.id;window.localStorage.setItem("trackInfo-"+e,function(t){var e=t.id,r=t.favorite,o=t.playedCount,n=t.position,a=t.lastUpdated,i=t.lastPlayed,s=[e,Number(r),o,n,a,i];return JSON.stringify(s)}(t)),this._addToIndex(e)},t.prototype.getFavorites=function(){return this.getAll().filter((function(t){return t.favorite}))},t.prototype.getById=function(t){var e=window.localStorage.getItem("trackInfo-"+t);if(e)return function(t){if(t){var e=JSON.parse(t),r=e[0],o=e[1],n=e[2],a=e[3],i=e[4],s=e[5];return{id:r,favorite:Boolean(o),playedCount:n,position:a,lastUpdated:i,lastPlayed:s}}}(e)},t.prototype._getFavoritesIndex=function(){try{var t=window.localStorage.getItem("trackInfoFavoritesIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setFavoritesIndex=function(t){window.localStorage.setItem("trackInfoFavoritesIndex",JSON.stringify(t))},t.prototype._addToFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)||(e.push(t),this._setFavoritesIndex(e))},t.prototype._removeFromFavoritesIndex=function(t){var e=this._getFavoritesIndex();e.includes(t)&&this._setFavoritesIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInFavoritesIndex=function(t,e){e?this._addToFavoritesIndex(t):this._removeFromFavoritesIndex(t)},t.prototype._getIndex=function(){try{var t=window.localStorage.getItem("trackInfoIndex");return t?JSON.parse(t):[]}catch(t){return[]}},t.prototype._setIndex=function(t){window.localStorage.setItem("trackInfoIndex",JSON.stringify(t))},t.prototype._addToIndex=function(t){var e=this._getIndex();e.includes(t)||(e.push(t),this._setIndex(e))},t.prototype._removeFromIndex=function(t){var e=this._getIndex();e.includes(t)&&this._setIndex(e.filter((function(e){return t!==e})))},t.prototype._toggleInIndex=function(t,e){e?this._addToIndex(t):this._removeFromIndex(t)},t.prototype.getAll=function(){var t=this;return this._getIndex().map((function(e){return t.getById(e)})).filter(Boolean)},t.prototype.delete=function(t){window.localStorage.removeItem("trackInfo-"+t),this._removeFromIndex(t)},t.prototype.clearAll=function(){this._getIndex().forEach((function(t){window.localStorage.removeItem("trackInfo-"+t)})),this._setIndex([])},t}()),l=document.body,f=void 0,p=void 0,v="true";function h(){var t=function(){if(!f){(f=document.createElement("div")).classList.add("shared-player");var t=document.createElement("audio");t.addEventListener("loadeddata",b),f.appendChild(t),l.appendChild(f)}return f}(),e=t.getElementsByTagName("audio")[0];if(!e)throw new Error(n("noAudioNodeFound"));return e}function y(t){if(!p)throw new Error("No current track player node!");var e=null==p?void 0:p.dataset;e&&delete e.status,function(){if(!p)throw new Error("No current track player node!");var t=p,e=t.dataset;e.incrementing||(e.incrementing=v,T(t,void 0),window.isAuthenticated?function(){var t=p.dataset,e=t.trackId;return s("/api/v1/tracks/".concat(e,"/increment-played-count/"),"POST")}().then((function(e){var r=e.played_count;null!=r&&T(t,r)})).catch((function(t){console.error("[tracksPlayer:incrementPlayedCount:sendIncrementPlayedCount] error",{err:t});debugger;throw o.showError(t),t})).finally((function(){delete e.incrementing})):delete e.incrementing)}()}function g(t,e,r){var o=t.querySelector(".time"),n=t.dataset,a=n.trackId,i=n.trackDuration,s=function(t){const e=t/1e3,r=e/60,o=r/60,n=[o/24,o%24,r%60,e%60].map(Math.floor).map(((t,e)=>{if(!(e<2)||t)return e>=1?String(t).padStart(2,"0"):e?void 0:String(t)+"d"}));return[n.shift(),n.filter(Boolean).join(":")].filter(Boolean).join(" ")}(Math.floor(1e3*e)),d=Number(a),c=parseFloat(i.replace(",","."));if(!c){var l=new Error("No duration provided for a track: ".concat(d));console.error("[tracksPlayer:updateTrackPosition]",l.message,{error:l});debugger}var f=e/c,p=Math.round(100*f);n.position=String(e),n.progress=String(p),t.style.setProperty("--progress",String(p)),o&&(o.innerHTML=s),u.updatePosition(d,e)}function m(t){if(p){var e,r=t.currentTarget.currentTime,o=p.dataset;Boolean(o.loaded)&&(e=r,p&&g(p,e))}}function w(t){if(!p)throw new Error("No current track player node!");p.dataset.status="playing",function(t){var e=t.dataset,r=e.trackDuration,o=e.trackId,n=Number(o),a=parseFloat(r.replace(",",".")),i=t.querySelector("img.card-img"),s=null==i?void 0:i.getAttribute("src"),d=t.querySelector(".post-title"),c=null==d?void 0:d.innerHTML,u=null==d?void 0:d.getAttribute("href");console.log("[floatingPlayer:initFloatingPlayer]",{id:n,duration:a,imgUrl:s,link:u,trackNode:t,title:c});debugger;document.body.classList.toggle("withPlayer",!0)}(p)}function I(t,e){void 0===e&&(e=!0);var r=h(),o=t.dataset,n=parseFloat(o.trackDuration.replace(",",".")),a=Number(o.position||"");a>=n-.1?(g(t,a=0),o.position="0",o.progress="0",r.currentTime=0):r.currentTime=a}function k(t,e){void 0===e&&(e=!0);var r=h();I(t,e),r.play()}function b(t){if(!p)throw new Error("No current track player node!");var e=p.dataset;e.loaded||(e.loaded=v,delete e.error,k(p,!0))}function E(t){var e=t.currentTarget,r=e.src,a=e.type,i=n("errorLoadingAudioFile")+" "+r,s=new Error(i);console.error("[sharedPlayerError]",i,{error:s,currentTrackPlayer:p,src:r,type:a,ev:t});debugger;o.showError(i);var d=null==p?void 0:p.dataset;d&&(d.error=i,delete d.loaded,delete d.status)}function T(t,r,o){var n=t.dataset.trackId,a=Number(n);if(!a)throw new Error("No current track id!");var i=u.updatePlayedCount(a,r).playedCount,s=e(String(i)),d=t.querySelector("#played_count");if(d){d.innerText=s;var c=d.closest(".track-played-count[data-played-count]");c&&(c.dataset.playedCount=s)}}function x(){if(!p)throw new Error("No current track player node!");var t=p.dataset,e=!!t.loaded,r=h();if(e)k(p,!0);else{t.status="waiting",delete t.loaded,delete t.error;var o=function(t){void 0===t&&(t={});for(var e=h(),r=0,o=Array.from(e.getElementsByTagName("source"));r<o.length;r++)o[r].remove();e.setAttribute("preload","auto");var n=document.createElement("source");return n.setAttribute("type",t.type||"audio/mpeg"),t.src&&n.setAttribute("src",t.src),e.addEventListener("canplay",b),e.addEventListener("loadeddata",b),e.addEventListener("playing",w),e.addEventListener("timeupdate",m),e.addEventListener("ended",y),n.addEventListener("error",E),e.appendChild(n),n}({src:t.trackMediaUrl});if(!o)throw new Error(n("noAudioSourceNodeFound"));I(p,!0),r.load()}}function S(t){var e=t.currentTarget.closest(".track-player");p&&p!==e&&function(){if(f){var t=f.getElementsByTagName("audio")[0];t&&function(t){return!!t&&t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>2}(t)&&t.pause()}if(p){p.classList.toggle("current",!1);var e=p.dataset;delete e.status,delete e.loaded,delete e.error}}();var r=e.dataset,o="playing"===r.status,n=!("waiting"===r.status||o),a=h();o?(a.pause(),r.status="paused"):n&&(p=e,window.localStorage.setItem("currentTrackId",String(r.trackId)),e.classList.toggle("current",!0),x())}function N(t,e){var r=t.dataset,o=r.favorite;e!==Boolean(o)&&(e?r.favorite=v:delete r.favorite)}function F(t){var e=t.currentTarget.closest(".track-player").dataset,r=e.trackId,a=e.favorite,i=Number(r);if(!i)throw new Error("No current track id!");var c=!a;u.updateFavorite(i,c),c?e.favorite=v:delete e.favorite,window.isAuthenticated&&function(t,e){return s("/api/v1/tracks/".concat(t,"/toggle-favorite/"),"POST",{value:e})}(r,c).then((function(t){var e,r=t.favorite_track_ids;e=r,u.updateFavoritesByTrackIds(e),d.forEach((function(t){var r=t.dataset.trackId,o=Number(r);N(t,e.includes(o))}));var a=c?"trackAddedToFavorites":"trackRemovedFromFavorites";o.showSuccess(n(a))})).catch((function(t){console.error("[tracksPlayer:toggleFavorite:sendToggleFavoriteRequest] error",{err:t});debugger;o.showError(t)}))}function L(t){var e=Number(window.localStorage.getItem("currentTrackId")||""),r=t.dataset,o=r.inited,n=r.trackId,a=r.trackMediaUrl,i=Number(n||"");if(i&&!o&&a){var s=i===e,d=u.getById(i);d&&(d.position&&g(t,d.position),window.isAuthenticated||(null==d?void 0:d.favorite)&&N(t,d.favorite)),s&&(p=t,t.classList.toggle("current",!0),r.status="paused"),t.querySelectorAll(".track-control").forEach((function(t){var e=t.dataset,r=e.inited,o=e.controlId;r||("toggleFavorite"===o&&t.addEventListener("click",F),"play"===o&&t.addEventListener("click",S),e.inited=v)})),r.inited=v}}void 0===c&&(c=document.body),(d=c.querySelectorAll(".track-player[data-track-media-url]")).forEach(L)})();
//# sourceMappingURL=scripts.js.map